---
title: 一个页面从输入 URL 到页面加载显示完成，这个过程中都发生了什么？
date: 2019-05-22 00:00:00 Z
categories:
- other
layout: article
keywords: URL,dns解析,TCP三次握手,浏览器解析渲染页面,一个页面从输入 URL 到页面加载显示完成，这个过程中都发生了什么
description: 一个页面从输入 URL 到页面加载显示完成，这个过程中都发生了什么
---

总体来说分为以下几个过程:

1. DNS解析：将域名解析成 IP 地址
2. 建立TCP/IP连接：TCP 三次握手
3. 发送HTTP请求
4. 服务器处理请求并返回HTTP报文
5. 浏览器解析渲染页面
6. 断开连接：TCP 四次挥手

---

## dns解析查找对应的IP地址


1. 浏览器搜索自己的 DNS 缓存；

2. 搜索操作系统中的 DNS 缓存；

3. 搜索操作系统的 hosts 文件（ Windows 环境下）；

4. 搜索路由缓存：路由器也有 DNS 缓存

5. 操作系统将域名发送至 LDNS（本地区域名服务器）；LDNS 查询自己的 DNS 缓存（一般查找成功率在 80% 左右），查找成功则返回结果，失败则发起一个迭代 DNS 解析请求；

    (1). LDNS 向 Root Name Server （根域名服务器，其虽然没有每个域名的的具体信息，但存储了负责每个域，如 com、net、org等的解析的顶级域名服务器的地址）发起请求，此处，Root Name Server 返回 com 域的顶级域名服务器的地址；

    (2). LDNS 向 com 域的顶级域名服务器发起请求，返回 baidu.com 域名服务器地址；

    (3). LDNS 向 baidu.com 域名服务器发起请求，得到 www.baidu.com 的 IP 地址；

6. LDNS 将得到的 IP 地址返回给操作系统，同时自己也将 IP 地址缓存起来；

7. 操作系统将 IP 地址返回给浏览器，同时自己也将 IP 地址缓存起来；

8. 至此，浏览器已经得到了域名对应的 IP 地址。

<strong>补充说明：</strong>

- 域名与 URL 是两个概念：域名是一台或一组服务器的名称，用来确定服务器在 Internet 上的位置；URL（Uniform Resource Locator）是统一资源定位符，用来确定某一个文件的具体位置，例如，zhihu.com 是 知乎的域名，根据这个域名可以找到知乎的服务器，zhihu.com/people/username 是 URL ，可以根据这个 URL 定位摸个知乎页面；

- IP 地址与域名不是一一对应的关系：可以把多个提供相同服务的服务器 IP 设置为同一个域名，但在同一时刻一个域名只能解析出一个 IP地址；同时，一个 IP 地址可以绑定多个域名


---


## TCP/IP连接--三次握手
> 简略版

  1. 客户端向服务器发送一个建立连接的请求（您好，我想建立连接）；
  2. 服务器接到请求后发送同意连接的信号（好的，可以建立连接）；
  3. 主机接到同意连接的信号后，再次向服务器发送了确认信号（确认建立连接）；

>详细版

  1. TCP第一次握手期间：客户机向服务器发送请求报文段，发送序号为x ；
  2. TCP第二次握手期间：服务器向客户机发送请求+确认报文段，发送序号为y，确认报文段为x+1； 
  3. TCP第三次握手期间：客户机向服务器发送确认报文段，发送序号为x+1，确认序号为y+1；

|   | 序列号 | 确认号 |
| :-: | :-: | :-: |
| 第一次握手 | x | |
| 第二次握手 | y | x + 1 |
| 第三次握手 | x + 1 | y + 1 |

![TCP三次握手](/assets/images/1594130600719.jpg)

> 谢希仁著《计算机网络》中讲“三次握手”的目的是“为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误”。

参考文献：[TCP 为什么是三次握手，而不是两次或四次？](https://www.zhihu.com/question/24853633)

自此，客户端与服务器两者建立了连接。（三次握手的过程采用 TCP 协议，其可以保证信息传输的可靠性，三次握手过程中，若一方收不到确认信号，协议会要求重新发送信号）

---


## 发送HTTP请求
当服务器与主机建立了连接之后，下面主机便与服务器进行通信。网页请求是一个单向请求的过程，即是一个主机向服务器请求数据，服务器返回相应的数据的过程。
浏览器根据 URL 内容生成 HTTP 请求，HTTP请求报文是由三部分组成: 请求行, 请求报头和请求正文；

如：

{% highlight http %}
POST /path HTTP/1.1
Host: passport.zhihu.com
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36
Accept: */*
Content-Length: 24
Content-Type: application/x-www-form-urlencoded
username=ff&password=123
{% endhighlight %}

---

##  服务器处理请求并返回HTTP报文

服务器接到请求后，会根据 HTTP 请求中的内容来决定如何获取相应的 HTML 文件；
服务器将得到的 HTML 文件发送给浏览器；
HTTP响应报文也是由三部分组成: 状态码, 响应报头和响应报文
- 状态码

1xx：指示信息–表示请求已接收，继续处理。

2xx：成功–表示请求已被成功接收、理解、接受。

3xx：重定向–要完成请求必须进行更进一步的操作。

4xx：客户端错误–请求有语法错误或请求无法实现。

5xx：服务器端错误–服务器未能实现合法的请求。

- 响应报头

常见的响应报头字段有: Server, Connection...

- 响应报文

服务器返回给浏览器的文本信息，通常HTML, CSS, JS, 图片等文件就放在这一部分。

---

## 浏览器解析渲染页面

在浏览器还没有完全接收 HTML 文件时便开始渲染、显示网页；
在执行 HTML 中代码时，根据需要，浏览器会继续请求图片、CSS、JavsScript等文件，过程同请求 HTML ；

浏览器是一个边解析边渲染的过程。首先浏览器解析HTML文件构建DOM树，然后解析CSS文件构建渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并将其绘制到屏幕上。这个过程比较复杂，涉及到两个概念: reflow(回流)和repain(重绘)。DOM节点中的各个元素都是以盒模型的形式存在，这些都需要浏览器去计算其位置和大小等，这个过程称为relow;当盒模型的位置,大小以及其他属性，如颜色,字体,等确定下来之后，浏览器便开始绘制内容，这个过程称为repain。页面在首次加载时必然会经历reflow和repain。reflow和repain过程是非常消耗性能的，尤其是在移动设备上，它会破坏用户体验，有时会造成页面卡顿。所以我们应该尽可能少的减少reflow和repain。

JS的解析是由浏览器中的JS解析引擎完成的。JS是单线程运行，也就是说，在同一个时间内只能做一件事，所有的任务都需要排队，前一个任务结束，后一个任务才能开始。但是又存在某些任务比较耗时，如IO读写等，所以需要一种机制可以先执行排在后面的任务，这就是：同步任务(synchronous)和异步任务(asynchronous)。JS的执行机制就可以看做是一个主线程加上一个任务队列(task queue)。同步任务就是放在主线程上执行的任务，异步任务是放在任务队列中的任务。所有的同步任务在主线程上执行，形成一个执行栈;异步任务有了运行结果就会在任务队列中放置一个事件；脚本运行时先依次运行执行栈，然后会从任务队列里提取事件，运行任务队列中的任务，这个过程是不断重复的，所以又叫做事件循环(Event loop)。

浏览器在解析过程中，如果遇到请求外部资源时，如图像,iconfont,JS等。浏览器将重复1-6过程下载该资源。请求过程是异步的，并不会影响HTML文档进行加载，但是当文档加载过程中遇到JS文件，HTML文档会挂起渲染过程，不仅要等到文档中JS文件加载完毕还要等待解析执行完毕，才会继续HTML的渲染过程。原因是因为JS有可能修改DOM结构，这就意味着JS执行完成前，后续所有资源的下载是没有必要的，这就是JS阻塞后续资源下载的根本原因。CSS文件的加载不影响JS文件的加载，但是却影响JS文件的执行。JS代码执行前浏览器必须保证CSS文件已经下载并加载完毕

---

## 连接结束

主机向服务器发送一个断开连接的请求（不早了，我该走了）；
服务器接到请求后发送确认收到请求的信号（知道了）；
服务器向主机发送断开通知（我也该走了）；
主机接到断开通知后断开连接并反馈一个确认信号（嗯，好的），服务器收到确认信号后断开连接；